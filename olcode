import { useState, useEffect } from "react";
import axios from "axios";
import { useParams, useNavigate } from "react-router-dom";
import {
  FaTimes,
  FaUser,
  FaStethoscope,
  FaFlask,
  FaHeartbeat,
  FaBrain,
  FaPills,
  FaNotesMedical,
  FaSpinner,
  FaPlus,
  FaTrash,
} from "react-icons/fa";
import { motion } from "framer-motion";
import SymptomsSelector from "./SymptomsSelector";
import TestsSelector from "./TestsSelector";
import NeuroExamSelect from "./NeuroExamSelect";
import FullPageLoader from "../pages/FullPageLoader";

const safeRequest = async (url, options = {}, retries = 3, delay = 1000) => {
  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      const response = await axios({
        url,
        timeout: 15000,
        ...options,
      });
      return { data: response.data, error: null };
    } catch (error) {
      if (attempt === retries || axios.isCancel(error)) {
        return { data: null, error };
      }
      console.warn(
        `Attempt ${attempt} failed for ${url}: ${error.message}. Retrying...`
      );
      await new Promise((resolve) => setTimeout(resolve, delay));
    }
  }
};

const getCachedData = (key) => {
  try {
    const data = sessionStorage.getItem(key);
    return data ? JSON.parse(data) : null;
  } catch {
    return null;
  }
};

const setCachedData = (key, data) => {
  try {
    sessionStorage.setItem(key, JSON.stringify(data));
  } catch (error) {
    console.warn(`Failed to cache ${key}: ${error.message}`);
  }
};

// Validation function for form fields
const validateForm = (formData) => {
  const errors = {};

  // Patient Details
  if (!formData.patient_name || formData.patient_name.length < 1) {
    errors.patient_name = "Patient name is required.";
  } else if (formData.patient_name.length > 100) {
    errors.patient_name = "Patient name must be 100 characters or less.";
  }

  if (formData.mobile && !/^\+?\d{10,15}$/.test(formData.mobile)) {
    errors.mobile =
      "Mobile number must be 10-15 digits, optionally starting with +.";
  }

  if (
    !formData.gender ||
    !["Male", "Female", "Other"].includes(formData.gender)
  ) {
    errors.gender = "Gender must be Male, Female, or Other.";
  }

  if (
    formData.age !== undefined &&
    (isNaN(formData.age) || formData.age < 0 || formData.age > 150)
  ) {
    errors.age = "Age must be between 0 and 150.";
  }

  if (
    !formData.visit_date ||
    !/^\d{4}-\d{2}-\d{2}$/.test(formData.visit_date)
  ) {
    errors.visit_date =
      "Visit date is required and must be in YYYY-MM-DD format.";
  }

  // Vital Signs
  formData.vital_signs?.forEach((vital, index) => {
    if (
      vital.blood_pressure &&
      !/^\d{1,3}\/\d{1,3}$/.test(vital.blood_pressure)
    ) {
      errors[`vital_signs_${index}_blood_pressure`] =
        "Blood pressure must be in systolic/diastolic format (e.g., 120/80).";
    }
    if (
      vital.pulse_rate &&
      (isNaN(vital.pulse_rate) ||
        vital.pulse_rate < 0 ||
        vital.pulse_rate > 300)
    ) {
      errors[`vital_signs_${index}_pulse_rate`] =
        "Pulse rate must be a number between 0 and 300.";
    }
    if (
      vital.temperature &&
      (isNaN(vital.temperature) ||
        vital.temperature < 90 ||
        vital.temperature > 110)
    ) {
      errors[`vital_signs_${index}_temperature`] =
        "Temperature must be a number between 90 and 110.";
    }
    if (
      vital.spo2_level &&
      (isNaN(vital.spo2_level) ||
        vital.spo2_level < 0 ||
        vital.spo2_level > 100)
    ) {
      errors[`vital_signs_${index}_spo2_level`] =
        "SpO2 level must be a number between 0 and 100.";
    }
    if (
      vital.nihss_score &&
      (typeof vital.nihss_score !== "string" || vital.nihss_score.length > 50)
    ) {
      errors[`vital_signs_${index}_nihss_score`] =
        "NIHSS score must be a string up to 50 characters.";
    }
    if (
      vital.fall_assessment &&
      (typeof vital.fall_assessment !== "string" ||
        vital.fall_assessment.length > 50)
    ) {
      errors[`vital_signs_${index}_fall_assessment`] =
        "Fall assessment must be a string up to 50 characters.";
    }
  });

  // Prescriptions
  formData.prescriptions?.forEach((pres, index) => {
    if (!pres.medicine_id) {
      errors[`prescriptions_${index}_medicine_id`] = "Medicine is required.";
    }
    if (pres.brand_name && pres.brand_name.length > 100) {
      errors[`prescriptions_${index}_brand_name`] =
        "Brand name must be 100 characters or less.";
    }
    if (
      pres.dosage_urdu &&
      !dosageOptions.some((opt) => opt.label === pres.dosage_urdu)
    ) {
      errors[`prescriptions_${index}_dosage_urdu`] =
        "Invalid dosage selection.";
    }
    if (
      pres.frequency_urdu &&
      !frequencyOptions.some((opt) => opt.label === pres.frequency_urdu)
    ) {
      errors[`prescriptions_${index}_frequency_urdu`] =
        "Invalid frequency selection.";
    }
    if (
      pres.duration_urdu &&
      !durationOptions.some((opt) => opt.label === pres.duration_urdu)
    ) {
      errors[`prescriptions_${index}_duration_urdu`] =
        "Invalid duration selection.";
    }
    if (
      pres.instructions_urdu &&
      !instructionsOptions.some((opt) => opt.label === pres.instructions_urdu)
    ) {
      errors[`prescriptions_${index}_instructions_urdu`] =
        "Invalid instructions selection.";
    }
  });

  // Diagnosis & Treatment
  if (formData.diagnosis && formData.diagnosis.length > 1000) {
    errors.diagnosis = "Diagnosis must be 1000 characters or less.";
  }
  if (formData.treatment_plan && formData.treatment_plan.length > 1000) {
    errors.treatment_plan = "Treatment plan must be 1000 characters or less.";
  }

  // Follow-Ups
  formData.follow_ups?.forEach((followUp, index) => {
    if (
      followUp.follow_up_date &&
      !/^\d{4}-\d{2}-\d{2}$/.test(followUp.follow_up_date)
    ) {
      errors[`follow_ups_${index}_follow_up_date`] =
        "Follow-up date must be in YYYY-MM-DD format.";
    }
    if (followUp.notes && followUp.notes.length > 500) {
      errors[`follow_ups_${index}_notes`] =
        "Notes must be 500 characters or less.";
    }
  });

  // Cognitive Scores
  if (
    formData.mmse_score &&
    (typeof formData.mmse_score !== "string" || formData.mmse_score.length > 50)
  ) {
    errors.mmse_score = "MMSE score must be a string up to 50 characters.";
  }
  if (
    formData.gcs_score &&
    (typeof formData.gcs_score !== "string" || formData.gcs_score.length > 50)
  ) {
    errors.gcs_score = "GCS score must be a string up to 50 characters.";
  }

  return errors;
};

const FormField = ({
  label,
  placeholder,
  value,
  onChange,
  urdu = false,
  type = "text",
  min,
  max,
  disabled = false,
  required = false,
  error,
}) => (
  <div style={{ marginBottom: "1rem" }}>
    <label
      style={{
        display: "block",
        fontSize: "0.875rem",
        fontWeight: "500",
        color: "#374151",
        marginBottom: "0.25rem",
      }}
    >
      {label}
      {required && <span style={{ color: "#ef4444" }}>*</span>}
    </label>
    <input
      type={type}
      value={value ?? ""}
      onChange={(e) => {
        let newValue =
          type === "number" ? e.target.valueAsNumber || 0 : e.target.value;
        if (type === "number" && min !== undefined && newValue < min)
          newValue = min;
        if (type === "number" && max !== undefined && newValue > max)
          newValue = max;
        onChange(newValue);
      }}
      placeholder={placeholder}
      min={min}
      max={max}
      disabled={disabled}
      required={required}
      style={{
        width: "100%",
        padding: "0.5rem",
        border: `1px solid ${error ? "#ef4444" : "#d1d5db"}`,
        borderRadius: "0.375rem",
        backgroundColor: "#ffffff",
        fontSize: "0.875rem",
        color: "#374151",
        outline: "none",
        transition: "all 0.2s",
        boxShadow: "0 1px 2px rgba(0, 0, 0, 0.05)",
        ...(urdu
          ? {
              fontFamily: "'Noto Nastaliq Urdu', sans-serif",
              textAlign: "right",
            }
          : {}),
        ...(disabled
          ? { backgroundColor: "#f3f4f6", cursor: "not-allowed" }
          : {}),
      }}
      onFocus={(e) =>
        (e.target.style.borderColor = error ? "#ef4444" : "#14b8a6")
      }
      onBlur={(e) =>
        (e.target.style.borderColor = error ? "#ef4444" : "#d1d5db")
      }
    />
    {error && (
      <p
        style={{ color: "#ef4444", fontSize: "0.75rem", marginTop: "0.25rem" }}
      >
        {error}
      </p>
    )}
  </div>
);

const CheckboxField = ({ label, checked, onChange }) => (
  <div style={{ marginBottom: "1rem", display: "flex", alignItems: "center" }}>
    <input
      type="checkbox"
      checked={checked || false}
      onChange={(e) => onChange(e.target.checked)}
      style={{
        height: "1rem",
        width: "1rem",
        color: "#14b8a6",
        border: "1px solid #d1d5db",
        borderRadius: "0.25rem",
        cursor: "pointer",
      }}
    />
    <label
      style={{
        marginLeft: "0.5rem",
        fontSize: "0.875rem",
        fontWeight: "500",
        color: "#374151",
      }}
    >
      {label}
    </label>
  </div>
);

const SelectField = ({
  label,
  value,
  onChange,
  options,
  urdu = false,
  bilingual = false,
  onEnglishChange = null,
  englishValue = null,
  required = false,
  error,
}) => {
  const handleChange = (selectedValue) => {
    if (bilingual) {
      const selectedOption = options.find(
        (opt) => opt.label === selectedValue || opt.value === selectedValue
      );
      onChange(selectedOption ? selectedOption.label : selectedValue);
      if (onEnglishChange) {
        onEnglishChange(selectedOption ? selectedOption.value : selectedValue);
      }
    } else {
      onChange(selectedValue);
    }
  };

  const displayValue = bilingual
    ? options.find((opt) => opt.value === englishValue)?.label || value
    : value;

  return (
    <div
      style={{
        marginBottom: "1rem",
        ...(urdu ? { fontFamily: "'Noto Nastaliq Urdu', sans-serif" } : {}),
      }}
    >
      <label
        style={{
          display: "block",
          fontSize: "0.875rem",
          fontWeight: "500",
          color: "#374151",
          marginBottom: "0.25rem",
        }}
      >
        {label}
        {required && <span style={{ color: "#ef4444" }}>*</span>}
      </label>
      <select
        value={displayValue || ""}
        onChange={(e) => handleChange(e.target.value)}
        style={{
          width: "100%",
          padding: "0.5rem",
          border: `1px solid ${error ? "#ef4444" : "#d1d5db"}`,
          borderRadius: "0.375rem",
          backgroundColor: "#ffffff",
          fontSize: "0.875rem",
          color: "#374151",
          outline: "none",
          transition: "all 0.2s",
          boxShadow: "0 1px 2px rgba(0, 0, 0, 0.05)",
          ...(urdu ? { textAlign: "right" } : {}),
        }}
        onFocus={(e) =>
          (e.target.style.borderColor = error ? "#ef4444" : "#14b8a6")
        }
        onBlur={(e) =>
          (e.target.style.borderColor = error ? "#ef4444" : "#d1d5db")
        }
        required={required}
      >
        <option value="" style={{ color: "#6b7280" }}>
          {urdu ? "منتخب کریں" : "Select Option"}
        </option>
        {options.map((opt) => (
          <option
            key={opt.value}
            value={bilingual ? opt.label : opt.value}
            style={{ color: "#374151" }}
          >
            {opt.label}
          </option>
        ))}
      </select>
      {error && (
        <p
          style={{
            color: "#ef4444",
            fontSize: "0.75rem",
            marginTop: "0.25rem",
          }}
        >
          {error}
        </p>
      )}
    </div>
  );
};

const TextAreaField = ({
  label,
  value,
  onChange,
  placeholder,
  error,
  maxLength,
}) => (
  <div style={{ marginBottom: "1rem" }}>
    <label
      style={{
        display: "block",
        fontSize: "0.875rem",
        fontWeight: "500",
        color: "#374151",
        marginBottom: "0.25rem",
      }}
    >
      {label}
    </label>
    <textarea
      value={value ?? ""}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
      maxLength={maxLength}
      style={{
        width: "100%",
        padding: "0.5rem",
        border: `1px solid ${error ? "#ef4444" : "#d1d5db"}`,
        borderRadius: "0.375rem",
        backgroundColor: "#ffffff",
        fontSize: "0.875rem",
        color: "#374151",
        outline: "none",
        transition: "all 0.2s",
        boxShadow: "0 1px 2px rgba(0, 0, 0, 0.05)",
        minHeight: "100px",
        resize: "vertical",
      }}
      onFocus={(e) =>
        (e.target.style.borderColor = error ? "#ef4444" : "#14b8a6")
      }
      onBlur={(e) =>
        (e.target.style.borderColor = error ? "#ef4444" : "#d1d5db")
      }
    />
    {error && (
      <p
        style={{ color: "#ef4444", fontSize: "0.75rem", marginTop: "0.25rem" }}
      >
        {error}
      </p>
    )}
  </div>
);

const dosageOptions = [
  { value: "0.25", label: "ایک چوتھائی گولی" },
  { value: "0.5", label: "آدھی گولی" },
  { value: "0.75", label: "تین چوتھائی گولی" },
  { value: "1", label: "ایک گولی" },
  { value: "1.5", label: "ڈیڑھ گولی" },
  { value: "2", label: "دو گولیاں" },
  { value: "3", label: "تین گولیاں" },
  { value: "4", label: "چار گولیاں" },
  { value: "5", label: "پانچ گولیاں" },
  { value: "1_capsule", label: "ایک کیپسول" },
  { value: "2_capsules", label: "دو کیپسول" },
  { value: "3_capsules", label: "تین کیپسول" },
  { value: "2.5_ml", label: "ڈھائی ملی لیٹر" },
  { value: "5_ml", label: "پانچ ملی لیٹر" },
  { value: "7.5_ml", label: "ساڑھے سات ملی لیٹر" },
  { value: "10_ml", label: "دس ملی لیٹر" },
  { value: "15_ml", label: "پندرہ ملی لیٹر" },
  { value: "20_ml", label: "بیس ملی لیٹر" },
  { value: "1_drop", label: "ایک قطرہ" },
  { value: "2_drops", label: "دو قطرے" },
  { value: "5_drops", label: "پانچ قطرے" },
  { value: "1_tsp", label: "ایک چائے کا چمچ" },
  { value: "2_tsp", label: "دو چائے کے چمچ" },
];

const dosageValueToLabel = {
  0.25: "ایک چوتھائی گولی",
  0.5: "آدھی گولی",
  0.75: "تین چوتھائی گولی",
  1: "ایک گولی",
  1.5: "ڈیڑھ گولی",
  2: "دو گولیاں",
  3: "تین گولیاں",
  4: "چار گولیاں",
  5: "پانچ گولیاں",
  "1_capsule": "ایک کیپسول",
  "2_capsules": "دو کیپسول",
  "3_capsules": "تین کیپسول",
  "2.5_ml": "ڈھائی ملی لیٹر",
  "5_ml": "پانچ ملی لیٹر",
  "7.5_ml": "ساڑھے سات ملی لیٹر",
  "10_ml": "دس ملی لیٹر",
  "15_ml": "پندرہ ملی لیٹر",
  "20_ml": "بیس ملی لیٹر",
  "1_drop": "ایک قطرہ",
  "2_drops": "دو قطرے",
  "5_drops": "پانچ قطرے",
  "1_tsp": "ایک چائے کا چمچ",
  "2_tsp": "دو چائے کے چمچ",
};

const frequencyOptions = [
  { value: "morning", label: "صبح" },
  { value: "afternoon", label: "دوپہر" },
  { value: "evening", label: "شام" },
  { value: "night", label: "رات" },
  { value: "morning_evening", label: "صبح، شام" },
  { value: "morning_night", label: "صبح، رات" },
  { value: "afternoon_evening", label: "دوپہر، شام" },
  { value: "afternoon_night", label: "دوپہر، رات" },
  { value: "morning_evening_night", label: "صبح، شام، رات" },
  { value: "morning_afternoon_evening", label: "صبح، دوپہر، شام" },
  { value: "as_needed", label: "حسب ضرورت" },
  { value: "morning_afternoon_night", label: "صبح، دوپہر، رات" },
  { value: "afternoon_evening_night", label: "دوپہر، شام، رات" },
  { value: "early_morning", label: "صبح سویرے" },
  { value: "late_morning", label: "دیر صبح" },
  { value: "late_afternoon", label: "دیر دوپہر" },
  { value: "sunset", label: "غروب آفتاب" },
  { value: "midnight", label: "آدھی رات" },
  { value: "late_night", label: "رات دیر گئے" },
  { value: "morning_afternoon", label: "صبح، دوپہر" },
  { value: "evening_night", label: "شام، رات" },
  { value: "early_morning_night", label: "صبح سویرے، رات" },
  { value: "morning_late_afternoon", label: "صبح، دیر دوپہر" },
  { value: "afternoon_sunset", label: "دوپہر، غروب آفتاب" },
  { value: "all_day", label: "پورا دن" },
  { value: "all_night", label: "پوری رات" },
  { value: "24_hours", label: "چوبیس گھنٹے" },
];

const frequencyValueToLabel = {
  morning: "صبح",
  afternoon: "دوپہر",
  evening: "شام",
  night: "رات",
  morning_evening: "صبح، شام",
  morning_night: "صبح، رات",
  afternoon_evening: "دوپہر، شام",
  afternoon_night: "دوپہر، رات",
  morning_evening_night: "صبح، شام، رات",
  morning_afternoon_evening: "صبح، دوپہر، شام",
  as_needed: "حسب ضرورت",
  morning_afternoon_night: "صبح، دوپہر، رات",
  afternoon_evening_night: "دوپہر، شام، رات",
  early_morning: "صبح سویرے",
  late_morning: "دیر صبح",
  late_afternoon: "دیر دوپہر",
  sunset: "غروب آفتاب",
  midnight: "آدھی رات",
  late_night: "رات دیر گئے",
  morning_afternoon: "صبح، دوپہر",
  evening_night: "شام، رات",
  early_morning_night: "صبح سویرے، رات",
  morning_late_afternoon: "صبح، دیر دوپہر",
  afternoon_sunset: "دوپہر، غروب آفتاب",
  all_day: "پورا دن",
  all_night: "پوری رات",
  "24_hours": "چوبیس گھنٹے",
};

const durationOptions = [
  { value: "1_day", label: "ایک دن" },
  { value: "2_days", label: "دو دن" },
  { value: "3_days", label: "تین دن" },
  { value: "4_days", label: "چار دن" },
  { value: "5_days", label: "پانچ دن" },
  { value: "6_days", label: "چھ دن" },
  { value: "7_days", label: "ایک ہفتہ" },
  { value: "10_days", label: "دس دن" },
  { value: "14_days", label: "دو ہفتے" },
  { value: "15_days", label: "پندرہ دن" },
  { value: "21_days", label: "تین ہفتے" },
  { value: "28_days", label: "چار ہفتے" },
  { value: "30_days", label: "ایک ماہ" },
  { value: "45_days", label: "پینتالیس دن" },
  { value: "60_days", label: "دو ماہ" },
  { value: "90_days", label: "تین ماہ" },
  { value: "1_week", label: "ایک ہفتہ" },
  { value: "2_weeks", label: "دو ہفتے" },
  { value: "3_weeks", label: "تین ہفتے" },
  { value: "4_weeks", label: "چار ہفتے" },
  { value: "6_weeks", label: "چھ ہفتے" },
  { value: "8_weeks", label: "آٹھ ہفتے" },
  { value: "12_weeks", label: "بارہ ہفتے" },
  { value: "1_month", label: "ایک ماہ" },
  { value: "2_months", label: "دو ماہ" },
  { value: "3_months", label: "تین ماہ" },
  { value: "4_months", label: "چار ماہ" },
  { value: "6_months", label: "چھ ماہ" },
  { value: "9_months", label: "نو ماہ" },
  { value: "12_months", label: "ایک سال" },
  { value: "18_months", label: "ڈیڑھ سال" },
  { value: "1_year", label: "ایک سال" },
  { value: "2_years", label: "دو سال" },
  { value: "3_years", label: "تین سال" },
  { value: "as_needed", label: "ضرورت کے مطابق" },
  { value: "until_finished", label: "دوا ختم ہونے تک" },
  { value: "lifetime", label: "زندگی بھر" },
  { value: "short_term", label: "مختصر مدت" },
  { value: "long_term", label: "طویل مدت" },
];

const durationValueToLabel = {
  "1_day": "ایک دن",
  "2_days": "دو دن",
  "3_days": "تین دن",
  "4_days": "چار دن",
  "5_days": "پانچ دن",
  "6_days": "چھ دن",
  "7_days": "ایک ہفتہ",
  "10_days": "دس دن",
  "14_days": "دو ہفتے",
  "15_days": "پندرہ دن",
  "21_days": "تین ہفتے",
  "28_days": "چار ہفتے",
  "30_days": "ایک ماہ",
  "45_days": "پینتالیس دن",
  "60_days": "دو ماہ",
  "90_days": "تین ماہ",
  "1_week": "ایک ہفتہ",
  "2_weeks": "دو ہفتے",
  "3_weeks": "تین ہفتے",
  "4_weeks": "چار ہفتے",
  "6_weeks": "چھ ہفتے",
  "8_weeks": "آٹھ ہفتے",
  "12_weeks": "بارہ ہفتے",
  "1_month": "ایک ماہ",
  "2_months": "دو ماہ",
  "3_months": "تین ماہ",
  "4_months": "چار ماہ",
  "6_months": "چھ ماہ",
  "9_months": "نو ماہ",
  "12_months": "ایک سال",
  "18_months": "ڈیڑھ سال",
  "1_year": "ایک سال",
  "2_years": "دو سال",
  "3_years": "تین سال",
  as_needed: "ضرورت کے مطابق",
  until_finished: "دوا ختم ہونے تک",
  lifetime: "زندگی بھر",
  short_term: "مختصر مدت",
  long_term: "طویل مدت",
};

const instructionsOptions = [
  { value: "before_meal", label: "کھانے سے پہلے" },
  { value: "after_meal", label: "کھانے کے بعد" },
  { value: "with_meal", label: "کھانے کے ساتھ" },
  { value: "with_water", label: "پانی کے ساتھ" },
  { value: "with_milk", label: "دودھ کے ساتھ" },
  { value: "with_juice", label: "جوس کے ساتھ" },
  { value: "on_empty_stomach", label: "خالی پیٹ" },
  { value: "before_breakfast", label: "ناشتے سے پہلے" },
  { value: "after_breakfast", label: "ناشتے کے بعد" },
  { value: "before_lunch", label: "دوپہر کے کھانے سے پہلے" },
  { value: "after_lunch", label: "دوپہر کے کھانے کے بعد" },
  { value: "before_dinner", label: "رات کے کھانے سے پہلے" },
  { value: "after_dinner", label: "رات کے کھانے کے بعد" },
  { value: "at_bedtime", label: "سونے سے پہلے" },
  { value: "chew_tab", label: "چبا کر کھائیں" },
  { value: "sublingual", label: "زیر زبان رکھیں" },
  { value: "avoid_alcohol", label: "الکحل سے پرہیز" },
  { value: "as_needed", label: "ضرورت کے مطابق" },
  { value: "as_directed", label: "ڈاکٹر کے مشورے سے" },
];

const instructionsValueToLabel = {
  before_meal: "کھانے سے پہلے",
  after_meal: "کھانے کے بعد",
  with_meal: "کھانے کے ساتھ",
  with_water: "پانی کے ساتھ",
  with_milk: "دودھ کے ساتھ",
  with_juice: "جوس کے ساتھ",
  on_empty_stomach: "خالی پیٹ",
  before_breakfast: "ناشتے سے پہلے",
  after_breakfast: "ناشتے کے بعد",
  before_lunch: "دوپہر کے کھانے سے پہلے",
  after_lunch: "دوپہر کے کھانے کے بعد",
  before_dinner: "رات کے کھانے سے پہلے",
  after_dinner: "رات کے کھانے کے بعد",
  at_bedtime: "سونے سے پہلے",
  chew_tab: "چبا کر کھائیں",
  sublingual: "زیر زبان رکھیں",
  avoid_alcohol: "الکحل سے پرہیز",
  as_needed: "ضرورت کے مطابق",
  as_directed: "ڈاکٹر کے مشورے سے",
};

const getEnglishValue = (urduLabel, options) => {
  if (!urduLabel) return "";
  const option = options.find((opt) => opt.label === urduLabel);
  return option ? option.value : urduLabel;
};

const EditConsultation = () => {
  const { patientId, consultationId } = useParams();
  const navigate = useNavigate();
  const [editFormData, setEditFormData] = useState(null);
  const [editLoading, setEditLoading] = useState(true);
  const [error, setError] = useState("");
  const [formErrors, setFormErrors] = useState({});
  const [allSymptoms, setAllSymptoms] = useState(
    getCachedData("symptoms") || []
  );
  const [allTests, setAllTests] = useState(getCachedData("tests") || []);
  const [allMedicines, setAllMedicines] = useState(
    getCachedData("medicines") || []
  );
  const [symptomsError, setSymptomsError] = useState(null);
  const [testsError, setTestsError] = useState(null);
  const [prescriptionsError, setPrescriptionsError] = useState(null);

  useEffect(() => {
    const abortController = new AbortController();
    let isMounted = true;

    const normalizeValue = (value, options, fieldType = null) => {
      if (!value) return "";
      const valueToLabelMaps = {
        dosage: dosageValueToLabel,
        frequency: frequencyValueToLabel,
        duration: durationValueToLabel,
        instructions: instructionsValueToLabel,
      };
      if (
        fieldType &&
        valueToLabelMaps[fieldType] &&
        value in valueToLabelMaps[fieldType]
      ) {
        return valueToLabelMaps[fieldType][value];
      }
      const option = options.find(
        (opt) => opt.value === value || opt.label === value
      );
      return option ? option.label : value;
    };

    const mapSymptomsToIds = (symptoms, allSymptoms) => {
      if (!Array.isArray(symptoms)) return [];
      return symptoms
        .map((symptom) => {
          if (typeof symptom === "number") return symptom;
          if (typeof symptom === "string") {
            const match = allSymptoms.find(
              (s) => s.name.toLowerCase() === symptom.toLowerCase()
            );
            return match ? match.id : null;
          }
          return symptom.id || null;
        })
        .filter((id) => id !== null);
    };

    const createNewVitalSign = () => ({
      blood_pressure: "",
      pulse_rate: "",
      temperature: "",
      spo2_level: "",
      nihss_score: "",
      fall_assessment: "Done",
      recorded_at: new Date().toISOString(),
    });

    const fetchData = async () => {
      try {
        setEditLoading(true);
        setError(null);
        setFormErrors({});
        setSymptomsError(null);
        setTestsError(null);
        setPrescriptionsError(null);

        const { data: consultationData, error: consultationError } =
          await safeRequest(
            `https://patient-management-backend-nine.vercel.app/api/patients/${patientId}/consultations/${consultationId}?t=${Date.now()}`,
            { signal: abortController.signal }
          );
        if (!consultationData || consultationError) {
          throw new Error(
            consultationError?.message || "Consultation not found"
          );
        }
        console.log(
          "Raw Consultation Data:",
          JSON.stringify(consultationData, null, 2)
        );

        const cachedSymptoms = getCachedData("symptoms");
        const cachedTests = getCachedData("tests");
        const cachedMedicines = getCachedData("medicines");

        const [
          { data: symptomsData, error: symptomsError },
          { data: testsData, error: testsError },
          { data: medicinesData, error: medicinesError },
        ] = await Promise.all([
          cachedSymptoms
            ? Promise.resolve({ data: cachedSymptoms, error: null })
            : safeRequest(
                "https://patient-management-backend-nine.vercel.app/api/symptoms",
                { signal: abortController.signal }
              ),
          cachedTests
            ? Promise.resolve({ data: cachedTests, error: null })
            : safeRequest(
                "https://patient-management-backend-nine.vercel.app/api/tests",
                { signal: abortController.signal }
              ),
          cachedMedicines
            ? Promise.resolve({ data: cachedMedicines, error: null })
            : safeRequest(
                "https://patient-management-backend-nine.vercel.app/api/medicines",
                { signal: abortController.signal }
              ),
        ]);

        if (isMounted) {
          if (symptomsError) setSymptomsError("Couldn't load symptoms list");
          if (testsError) setTestsError("Couldn't load tests list");
          if (medicinesError)
            setPrescriptionsError(
              "Couldn't load medicines list. Existing prescriptions will be displayed."
            );

          const referenceData = {
            symptoms: symptomsData ? symptomsData.filter(Boolean) : [],
            tests: testsData ? testsData.filter(Boolean) : [],
            medicines: medicinesData ? medicinesData.filter(Boolean) : [],
          };

          if (symptomsData && !cachedSymptoms)
            setCachedData("symptoms", symptomsData);
          if (testsData && !cachedTests) setCachedData("tests", testsData);
          if (medicinesData && !cachedMedicines)
            setCachedData("medicines", medicinesData);

          // Normalize tests
          const normalizedTests = (consultationData.tests || [])
            .map((t) => {
              console.log("Processing test:", t);
              const testId = t.test_id || t.id;
              if (!Number.isInteger(testId)) {
                console.warn("Invalid test ID:", t);
                return null;
              }
              return testId;
            })
            .filter(Boolean);
          console.log("Normalized Tests:", normalizedTests);

          // Check for missing test IDs in allTests
          const allTestIds = referenceData.tests.map((t) => t.id);
          const missingTestIds = normalizedTests.filter(
            (id) => !allTestIds.includes(id)
          );
          if (missingTestIds.length > 0) {
            console.warn("Test IDs not in allTests:", missingTestIds);
            setTestsError(
              `Some tests (IDs: ${missingTestIds.join(
                ", "
              )}) are not available. Please reselect tests.`
            );
          }

          const prescriptions = (consultationData.prescriptions || []).map(
            (pres) => ({
              medicine_id: pres.medicine_id || "",
              brand_name: pres.brand_name || "",
              dosage_en:
                pres.dosage_en ||
                getEnglishValue(pres.dosage_urdu, dosageOptions),
              frequency_en:
                pres.frequency_en ||
                getEnglishValue(pres.frequency_urdu, frequencyOptions),
              duration_en:
                pres.duration_en ||
                getEnglishValue(pres.duration_urdu, durationOptions),
              instructions_en:
                pres.instructions_en ||
                getEnglishValue(pres.instructions_urdu, instructionsOptions),
              dosage_urdu: normalizeValue(
                pres.dosage_urdu || pres.dosage_en,
                dosageOptions,
                "dosage"
              ),
              frequency_urdu: normalizeValue(
                pres.frequency_urdu || pres.frequency_en,
                frequencyOptions,
                "frequency"
              ),
              duration_urdu: normalizeValue(
                pres.duration_urdu || pres.duration_en,
                durationOptions,
                "duration"
              ),
              instructions_urdu: normalizeValue(
                pres.instructions_urdu || pres.instructions_en,
                instructionsOptions,
                "instructions"
              ),
              prescribed_at: pres.prescribed_at || new Date().toISOString(),
            })
          );

          setAllSymptoms(referenceData.symptoms);
          setAllTests(referenceData.tests);
          setAllMedicines(referenceData.medicines);

          const newFormData = {
            ...consultationData,
            patient_name: consultationData.patient_name || "",
            gender: consultationData.gender || "Male",
            mobile: consultationData.mobile || "",
            age: consultationData.age || "",
            symptoms: mapSymptomsToIds(
              consultationData.symptoms || [],
              referenceData.symptoms
            ),
            rawSymptoms: consultationData.symptoms || [],
            tests: normalizedTests,
            diagnosis: consultationData.neuro_diagnosis || "",
            treatment_plan: consultationData.neuro_treatment_plan || "",
            motor_function: consultationData.motor_function || "",
            muscle_tone: consultationData.muscle_tone || "",
            muscle_strength: consultationData.muscle_strength || "",
            coordination: consultationData.coordination || "",
            deep_tendon_reflexes: consultationData.deep_tendon_reflexes || "",
            gait_assessment: consultationData.gait_assessment || "",
            cranial_nerves: consultationData.cranial_nerves || "",
            romberg_test: consultationData.romberg_test || "",
            plantar_reflex: consultationData.plantar_reflex || "",
            straight_leg_raise_left:
              consultationData.straight_leg_raise_left || "",
            straight_leg_raise_right:
              consultationData.straight_leg_raise_right || "",
            pupillary_reaction: consultationData.pupillary_reaction || "",
            speech_assessment: consultationData.speech_assessment || "",
            sensory_examination: consultationData.sensory_examination || "",
            fundoscopy: consultationData.fundoscopy || "",
            brudzinski_sign: consultationData.brudzinski_sign || false,
            kernig_sign: consultationData.kernig_sign || false,
            temperature_sensation:
              consultationData.temperature_sensation || false,
            pain_sensation: consultationData.pain_sensation || false,
            vibration_sense: consultationData.vibration_sense || false,
            proprioception: consultationData.proprioception || false,
            facial_sensation: consultationData.facial_sensation || false,
            swallowing_function: consultationData.swallowing_function || false,
            mmse_score: consultationData.mmse_score || "",
            gcs_score: consultationData.gcs_score || "",
            notes: consultationData.notes || "",
            prescriptions,
            vital_signs: consultationData.vital_signs?.length
              ? consultationData.vital_signs
              : [createNewVitalSign()],
            follow_ups: (consultationData.follow_ups || []).map((f) => ({
              id: f.id || null,
              follow_up_date: f.follow_up_date
                ? new Date(f.follow_up_date).toISOString().split("T")[0]
                : "",
              notes: f.notes || "",
              created_at: f.created_at || new Date().toISOString(),
            })),
          };

          setEditFormData(newFormData);
          setFormErrors(validateForm(newFormData));
        }
      } catch (error) {
        if (isMounted && !axios.isCancel(error)) {
          setError(error.message || "Failed to load consultation data");
          console.error("Fetch error:", error);
        }
      } finally {
        if (isMounted) setEditLoading(false);
      }
    };

    fetchData();

    return () => {
      isMounted = false;
      abortController.abort();
    };
  }, [patientId, consultationId]);

  const handleFormChange = (field, value) => {
    setEditFormData((prev) => {
      const newData = { ...prev, [field]: value };
      setFormErrors(validateForm(newData));
      return newData;
    });
  };

  const addMedicine = () => {
    setEditFormData((prev) => ({
      ...prev,
      prescriptions: [
        ...(prev.prescriptions || []),
        {
          medicine_id: "",
          brand_name: "",
          dosage_en: "",
          frequency_en: "",
          duration_en: "",
          instructions_en: "",
          dosage_urdu: "",
          frequency_urdu: "",
          duration_urdu: "",
          instructions_urdu: "",
          prescribed_at: new Date().toISOString(),
        },
      ],
    }));
  };

  const removeMedicine = (index) => {
    setEditFormData((prev) => {
      const newPrescriptions = prev.prescriptions.filter((_, i) => i !== index);
      const newFormData = { ...prev, prescriptions: newPrescriptions };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const addVitalSign = () => {
    setEditFormData((prev) => {
      const newVitalSigns = [
        ...(prev.vital_signs || []),
        {
          blood_pressure: "",
          pulse_rate: "",
          temperature: "",
          spo2_level: "",
          nihss_score: "",
          fall_assessment: "Done",
          recorded_at: new Date().toISOString(),
        },
      ];
      const newFormData = { ...prev, vital_signs: newVitalSigns };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const removeVitalSign = (index) => {
    setEditFormData((prev) => {
      const newVitalSigns = prev.vital_signs.filter((_, i) => i !== index);
      const newFormData = { ...prev, vital_signs: newVitalSigns };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const addFollowUp = () => {
    setEditFormData((prev) => {
      const newFollowUps = [
        ...(prev.follow_ups || []),
        {
          follow_up_date: "",
          notes: "",
          created_at: new Date().toISOString(),
        },
      ];
      const newFormData = { ...prev, follow_ups: newFollowUps };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const removeFollowUp = (index) => {
    setEditFormData((prev) => {
      const newFollowUps = prev.follow_ups.filter((_, i) => i !== index);
      const newFormData = { ...prev, follow_ups: newFollowUps };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const updateField = (section, index, field, value) => {
    setEditFormData((prev) => {
      const newData = [...(prev[section] || [])];
      newData[index] = { ...newData[index], [field]: value };
      const newFormData = { ...prev, [section]: newData };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const updatePrescriptionField = (index, field, value, isUrdu = false) => {
    setEditFormData((prev) => {
      const newPrescriptions = [...(prev.prescriptions || [])];
      const prescription = { ...newPrescriptions[index] };

      if (isUrdu) {
        prescription[`${field}_urdu`] = value;
        prescription[`${field}_en`] = getEnglishValue(
          value,
          eval(`${field}Options`)
        );
      } else {
        prescription[`${field}_en`] = value;
        prescription[`${field}_urdu`] = normalizeValue(
          value,
          eval(`${field}Options`),
          field
        );
      }

      newPrescriptions[index] = prescription;
      const newFormData = { ...prev, prescriptions: newPrescriptions };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const removeSymptom = (symptomId) => {
    setEditFormData((prev) => {
      const newSymptoms = prev.symptoms.filter((id) => id !== symptomId);
      const newFormData = { ...prev, symptoms: newSymptoms };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const removeTest = (testId) => {
    console.log("EditConsultationForm - Removing test ID:", testId);
    setEditFormData((prev) => {
      const newTests = prev.tests.filter((id) => id !== testId);
      const newFormData = { ...prev, tests: newTests };
      setFormErrors(validateForm(newFormData));
      return newFormData;
    });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      setEditLoading(true);
      setError(null);
      setPrescriptionsError(null);

      const validationErrors = validateForm(editFormData);
      if (Object.keys(validationErrors).length > 0) {
        setFormErrors(validationErrors);
        setError("Please fix the validation errors before submitting.");
        setEditLoading(false);
        return;
      }

      const validTestIds = editFormData.tests.filter((testId) =>
        allTests.some((test) => test.id === testId)
      );
      if (editFormData.tests.length !== validTestIds.length) {
        console.warn(
          "Invalid test IDs found:",
          editFormData.tests.filter((id) => !validTestIds.includes(id))
        );
        setError("Some selected tests are invalid. Please reselect tests.");
        setEditLoading(false);
        return;
      }

      const payload = {
        ...editFormData,
        patient_id: Number(patientId),
        consultation_id: Number(consultationId),
        patient_name: editFormData.patient_name,
        gender: editFormData.gender,
        mobile: editFormData.mobile,
        age: editFormData.age,
        tests: validTestIds,
        prescriptions: editFormData.prescriptions.map((pres) => ({
          medicine_id: pres.medicine_id,
          brand_name: pres.brand_name,
          dosage_en: pres.dosage_en,
          frequency_en: pres.frequency_en,
          duration_en: pres.duration_en,
          instructions_en: pres.instructions_en,
          dosage_urdu: pres.dosage_urdu,
          frequency_urdu: pres.frequency_urdu,
          duration_urdu: pres.duration_urdu,
          instructions_urdu: pres.instructions_urdu,
          prescribed_at: pres.prescribed_at,
        })),
        vital_signs: editFormData.vital_signs.map((vital) => ({
          blood_pressure: vital.blood_pressure,
          pulse_rate: vital.pulse_rate,
          temperature: vital.temperature,
          spo2_level: vital.spo2_level,
          nihss_score: vital.nihss_score,
          fall_assessment: vital.fall_assessment,
          recorded_at: vital.recorded_at,
        })),
        follow_ups: editFormData.follow_ups.map((f) => ({
          follow_up_date: f.follow_up_date,
          notes: f.notes || null,
        })),
      };

      const cleanedPayload = Object.fromEntries(
        Object.entries(payload).filter(
          ([_, v]) => v !== null && v !== undefined && v !== ""
        )
      );
      console.log(
        "Submitting payload:",
        JSON.stringify(cleanedPayload, null, 2)
      );

      const response = await axios.put(
        `http://localhost:4500/api/patients/consultations/${consultationId}`,
        cleanedPayload,
        {
          validateStatus: (status) => status < 500,
          headers: { "Content-Type": "application/json" },
        }
      );

      if (response.status === 400) {
        throw new Error(response.data.message || "Validation failed");
      }

      if (response.status >= 200 && response.status < 300) {
        sessionStorage.removeItem(`patient_${patientId}_consultations`);
        handlePrint();
        navigate(`/patients/${patientId}`);
      }
    } catch (error) {
      console.error("Update error:", error);
      setError(
        error.response?.data?.message ||
          error.message ||
          "Update failed. Please check your input."
      );
    } finally {
      setEditLoading(false);
    }
  };

  const handlePrint = () => {
    const printUrl = `https://patient-management-backend-nine.vercel.app/api/patients/${patientId}/consultations/${consultationId}/print?lang=urdu`;
    const printWindow = window.open(printUrl, "_blank");
    if (!printWindow) {
      alert("Pop-up blocked! Allow pop-ups for this site.");
    }
  };

  const handleCancel = () => {
    if (
      window.confirm(
        "Are you sure you want to cancel? Unsaved changes will be lost."
      )
    ) {
      navigate(`/patients/${patientId}`);
    }
  };

  if (editLoading && !editFormData) {
    return <FullPageLoader isLoading={true} />;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center p-4">
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
        className="w-full max-w-7xl bg-white p-8 rounded-2xl shadow-2xl max-h-[90vh] overflow-auto"
      >
        {editLoading && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <motion.div
              animate={{ rotate: 360 }}
              transition={{ repeat: Infinity, duration: 1, ease: "linear" }}
            >
              <FaSpinner className="w-12 h-12 text-teal-500" />
            </motion.div>
            <p className="text-lg font-medium text-white ml-4">
              Saving Changes...
            </p>
          </div>
        )}
        {error && (
          <div className="mb-6 p-4 bg-red-100 text-red-800 rounded-lg flex items-center gap-2">
            <FaTimes className="text-red-800" />
            {error}
            <button
              onClick={() => setError("")}
              className="ml-auto text-red-800 hover:text-red-900 transition-colors"
            >
              <FaTimes />
            </button>
          </div>
        )}
        {symptomsError && (
          <div className="mb-6 p-4 bg-yellow-100 text-yellow-800 rounded-lg flex items-center gap-2">
            <FaTimes className="text-yellow-800" />
            {symptomsError}
            <button
              onClick={() => setSymptomsError("")}
              className="ml-auto text-yellow-800 hover:text-yellow-900 transition-colors"
            >
              <FaTimes />
            </button>
          </div>
        )}
        {testsError && (
          <div className="mb-6 p-4 bg-yellow-100 text-yellow-800 rounded-lg flex items-center gap-2">
            <FaTimes className="text-yellow-800" />
            {testsError}
            <button
              onClick={() => setTestsError("")}
              className="ml-auto text-yellow-800 hover:text-yellow-900 transition-colors"
            >
              <FaTimes />
            </button>
          </div>
        )}
        {prescriptionsError && (
          <div className="mb-6 p-4 bg-yellow-100 text-yellow-800 rounded-lg flex items-center gap-2">
            <FaTimes className="text-yellow-800" />
            {prescriptionsError}
            <button
              onClick={() => setPrescriptionsError("")}
              className="ml-auto text-yellow-800 hover:text-yellow-900 transition-colors"
            >
              <FaTimes />
            </button>
          </div>
        )}

        <div className="flex justify-between items-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900">
            Edit Consultation
          </h2>
          <button
            onClick={handleCancel}
            className="text-red-500 bg-gray-100 rounded-full p-2 hover:text-red-600 hover:scale-110 transition-all"
            aria-label="Cancel"
          >
            <FaTimes className="text-xl" />
          </button>
        </div>

        {editFormData ? (
          <form onSubmit={handleSubmit} className="space-y-8">
            {/* Patient Information */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.1 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaUser className="w-6 h-6 text-teal-500" />
                Patient Information
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <FormField
                  label="Patient Name"
                  value={editFormData.patient_name}
                  onChange={(val) => handleFormChange("patient_name", val)}
                  placeholder="Enter patient name"
                  required
                  error={formErrors.patient_name}
                />
                <FormField
                  label="Mobile"
                  value={editFormData.mobile}
                  onChange={(val) => handleFormChange("mobile", val)}
                  placeholder="Enter mobile number"
                  error={formErrors.mobile}
                />
                <FormField
                  label="Visit Date"
                  type="date"
                  value={editFormData.visit_date?.split("T")[0] || ""}
                  onChange={(val) => handleFormChange("visit_date", val)}
                  required
                  error={formErrors.visit_date}
                />
                <FormField
                  label="Age"
                  type="number"
                  value={editFormData.age}
                  onChange={(val) => handleFormChange("age", val)}
                  placeholder="Enter age"
                  min={0}
                  max={150}
                  error={formErrors.age}
                />
                <SelectField
                  label="Gender"
                  value={editFormData.gender}
                  onChange={(val) => handleFormChange("gender", val)}
                  options={[
                    { value: "Male", label: "Male" },
                    { value: "Female", label: "Female" },
                    { value: "Other", label: "Other" },
                  ]}
                  required
                  error={formErrors.gender}
                />
              </div>
            </motion.div>

            {/* Vital Signs */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.2 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaHeartbeat className="w-6 h-6 text-red-500" />
                Vital Signs
              </h3>
              {editFormData.vital_signs?.map((vital, index) => (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, x: -20 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: index * 0.1 }}
                  className="mb-4 p-4 bg-white rounded-lg shadow-sm flex flex-wrap gap-4 items-center hover:shadow-md transition-shadow"
                >
                  <div className="flex-1 min-w-[200px]">
                    <FormField
                      label="Blood Pressure"
                      placeholder="e.g., 120/80 mmHg"
                      value={vital.blood_pressure}
                      onChange={(val) =>
                        updateField("vital_signs", index, "blood_pressure", val)
                      }
                      error={formErrors[`vital_signs_${index}_blood_pressure`]}
                    />
                  </div>
                  <div className="flex-1 min-w-[200px]">
                    <FormField
                      label="Pulse Rate"
                      placeholder="e.g., 80 bpm"
                      value={vital.pulse_rate}
                      onChange={(val) =>
                        updateField("vital_signs", index, "pulse_rate", val)
                      }
                      error={formErrors[`vital_signs_${index}_pulse_rate`]}
                    />
                  </div>
                  <div className="flex-1 min-w-[200px]">
                    <FormField
                      label="Temperature"
                      placeholder="e.g., 98.6°F"
                      value={vital.temperature}
                      onChange={(val) =>
                        updateField("vital_signs", index, "temperature", val)
                      }
                      error={formErrors[`vital_signs_${index}_temperature`]}
                    />
                  </div>
                  <div className="flex-1 min-w-[200px]">
                    <FormField
                      label="SpO2 Level"
                      placeholder="e.g., 98%"
                      value={vital.spo2_level}
                      onChange={(val) =>
                        updateField("vital_signs", index, "spo2_level", val)
                      }
                      error={formErrors[`vital_signs_${index}_spo2_level`]}
                    />
                  </div>
                  <div className="flex-1 min-w-[200px]">
                    <FormField
                      label="NIHSS Score"
                      placeholder="e.g., 0"
                      value={vital.nihss_score}
                      onChange={(val) =>
                        updateField("vital_signs", index, "nihss_score", val)
                      }
                      error={formErrors[`vital_signs_${index}_nihss_score`]}
                    />
                  </div>
                  <div className="flex-1 min-w-[200px]">
                    <SelectField
                      label="Fall Assessment"
                      value={vital.fall_assessment}
                      onChange={(val) =>
                        updateField(
                          "vital_signs",
                          index,
                          "fall_assessment",
                          val
                        )
                      }
                      options={[
                        { value: "Done", label: "Done" },
                        { value: "Not Done", label: "Not Done" },
                      ]}
                      error={formErrors[`vital_signs_${index}_fall_assessment`]}
                    />
                  </div>
                  {editFormData.vital_signs.length > 1 && (
                    <button
                      type="button"
                      onClick={() => removeVitalSign(index)}
                      className="text-red-500 hover:text-red-600 hover:scale-110 transition-all"
                      aria-label="Remove Vital Sign"
                    >
                      <FaTrash className="w-5 h-5" />
                    </button>
                  )}
                </motion.div>
              ))}
              <button
                type="button"
                onClick={addVitalSign}
                className="mt-4 px-4 py-2 bg-teal-500 text-white rounded-md flex items-center gap-2 hover:bg-teal-600 transition-colors"
              >
                <FaPlus /> Add Vital Sign
              </button>
            </motion.div>

            {/* Symptoms */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.3 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaStethoscope className="w-6 h-6 text-blue-500" />
                Symptoms
              </h3>
              <SymptomsSelector
                allSymptoms={allSymptoms}
                selectedSymptoms={editFormData.symptoms}
                rawSymptoms={editFormData.rawSymptoms || []}
                onSelect={(val) => handleFormChange("symptoms", val)}
                onRemove={removeSymptom}
              />
            </motion.div>

            {/* Tests */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.4 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaFlask className="w-6 h-6 text-green-500" />
                Tests
              </h3>
              <TestsSelector
                allTests={allTests}
                selectedTests={editFormData.tests}
                onSelect={(newTestIds) =>
                  setEditFormData({
                    ...editFormData,
                    tests: [...new Set(newTestIds)],
                  })
                }
                onRemove={removeTest}
              />
            </motion.div>

            {/* Neurological Examination */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.5 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaBrain className="w-6 h-6 text-purple-500" />
                Neurological Examination
              </h3>
              <div className="space-y-6">
                <div>
                  <h4 className="text-lg font-medium text-gray-700 mb-4">
                    Examination Details
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <NeuroExamSelect
                      field="motor_function"
                      value={editFormData.motor_function || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="muscle_tone"
                      value={editFormData.muscle_tone || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="muscle_strength"
                      value={editFormData.muscle_strength || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="coordination"
                      value={editFormData.coordination || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="deep_tendon_reflexes"
                      value={editFormData.deep_tendon_reflexes || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="gait_assessment"
                      value={editFormData.gait_assessment || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="cranial_nerves"
                      value={editFormData.cranial_nerves || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="romberg_test"
                      value={editFormData.romberg_test || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="plantar_reflex"
                      value={editFormData.plantar_reflex || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="straight_leg_raise_left"
                      value={editFormData.straight_leg_raise_left || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="straight_leg_raise_right"
                      value={editFormData.straight_leg_raise_right || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="pupillary_reaction"
                      value={editFormData.pupillary_reaction || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="speech_assessment"
                      value={editFormData.speech_assessment || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="sensory_examination"
                      value={editFormData.sensory_examination || ""}
                      onChange={handleFormChange}
                    />
                    <NeuroExamSelect
                      field="fundoscopy"
                      value={editFormData.fundoscopy || ""}
                      onChange={handleFormChange}
                    />
                  </div>
                </div>

                <div>
                  <h4 className="text-lg font-medium text-gray-700 mb-4">
                    Sensory and Neurological Signs
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <CheckboxField
                      label="Brudzinski Sign"
                      checked={editFormData.brudzinski_sign || false}
                      onChange={(val) =>
                        handleFormChange("brudzinski_sign", val)
                      }
                    />
                    <CheckboxField
                      label="Kernig Sign"
                      checked={editFormData.kernig_sign || false}
                      onChange={(val) => handleFormChange("kernig_sign", val)}
                    />
                    <CheckboxField
                      label="Temperature Sensation"
                      checked={editFormData.temperature_sensation || false}
                      onChange={(val) =>
                        handleFormChange("temperature_sensation", val)
                      }
                    />
                    <CheckboxField
                      label="Pain Sensation"
                      checked={editFormData.pain_sensation || false}
                      onChange={(val) =>
                        handleFormChange("pain_sensation", val)
                      }
                    />
                    <CheckboxField
                      label="Vibration Sense"
                      checked={editFormData.vibration_sense || false}
                      onChange={(val) =>
                        handleFormChange("vibration_sense", val)
                      }
                    />
                    <CheckboxField
                      label="Proprioception"
                      checked={editFormData.proprioception || false}
                      onChange={(val) =>
                        handleFormChange("proprioception", val)
                      }
                    />
                    <CheckboxField
                      label="Facial Sensation"
                      checked={editFormData.facial_sensation || false}
                      onChange={(val) =>
                        handleFormChange("facial_sensation", val)
                      }
                    />
                    <CheckboxField
                      label="Swallowing Function"
                      checked={editFormData.swallowing_function || false}
                      onChange={(val) =>
                        handleFormChange("swallowing_function", val)
                      }
                    />
                  </div>
                </div>

                <div>
                  <h4 className="text-lg font-medium text-gray-700 mb-4">
                    Cognitive Scores
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <FormField
                      label="MMSE Score (0–30)"
                      type="number"
                      value={editFormData.mmse_score}
                      onChange={(val) => handleFormChange("mmse_score", val)}
                      placeholder="Enter MMSE score"
                      min={0}
                      max={30}
                    />
                    <FormField
                      label="GCS Score (3–15)"
                      type="number"
                      value={editFormData.gcs_score}
                      onChange={(val) => handleFormChange("gcs_score", val)}
                      placeholder="Enter GCS score"
                      min={3}
                      max={15}
                    />
                  </div>
                </div>
              </div>
            </motion.div>

            {/* Prescriptions */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.6 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaPills className="w-6 h-6 text-amber-500" />
                Prescriptions
              </h3>
              {editFormData.prescriptions?.map((med, index) => (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, x: -20 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: index * 0.1 }}
                  className="mb-4 p-4 bg-white rounded-lg shadow-sm flex flex-wrap gap-4 items-center hover:shadow-md transition-shadow"
                >
                  <div className="flex-1 min-w-[200px]">
                    <label className="block text-sm font-medium text-gray-700 mb-1 font-urdu">
                      دوائی
                    </label>
                    <select
                      value={med.medicine_id || ""}
                      onChange={(e) => {
                        const selectedMedicine = allMedicines.find(
                          (m) => m.id === parseInt(e.target.value)
                        );
                        updateField(
                          "prescriptions",
                          index,
                          "medicine_id",
                          e.target.value
                        );
                        updateField(
                          "prescriptions",
                          index,
                          "brand_name",
                          selectedMedicine?.brand_name || ""
                        );
                      }}
                      className="w-full p-3 border border-gray-300 rounded-md bg-white text-sm text-gray-700 focus:outline-none focus:border-teal-500 transition-all shadow-sm"
                      disabled={allMedicines.length === 0 && !med.brand_name}
                    >
                      <option value="" className="text-gray-500">
                        {allMedicines.length === 0 && med.brand_name
                          ? med.brand_name
                          : "دوائی منتخب کریں"}
                      </option>
                      {allMedicines.length > 0
                        ? allMedicines.map((medicine) => (
                            <option
                              key={medicine.id}
                              value={medicine.id}
                              className="text-gray-700"
                            >
                              {medicine.form || ""} {medicine.brand_name || ""}{" "}
                              {medicine.strength || ""}
                            </option>
                          ))
                        : med.brand_name && (
                            <option value={med.medicine_id}>
                              {med.brand_name}
                            </option>
                          )}
                    </select>
                  </div>
                  <SelectField
                    label="خوراک"
                    value={med.dosage_urdu}
                    englishValue={med.dosage_en}
                    onChange={(val) =>
                      updateField("prescriptions", index, "dosage_urdu", val)
                    }
                    onEnglishChange={(val) =>
                      updateField("prescriptions", index, "dosage_en", val)
                    }
                    options={dosageOptions}
                    urdu
                    bilingual={true}
                    className="flex-1 min-w-[150px]"
                  />
                  <SelectField
                    label="تعدد"
                    value={med.frequency_urdu}
                    englishValue={med.frequency_en}
                    onChange={(val) =>
                      updateField("prescriptions", index, "frequency_urdu", val)
                    }
                    onEnglishChange={(val) =>
                      updateField("prescriptions", index, "frequency_en", val)
                    }
                    options={frequencyOptions}
                    urdu
                    bilingual={true}
                    className="flex-1 min-w-[150px]"
                  />
                  <SelectField
                    label="مدت"
                    value={med.duration_urdu}
                    englishValue={med.duration_en}
                    onChange={(val) =>
                      updateField("prescriptions", index, "duration_urdu", val)
                    }
                    onEnglishChange={(val) =>
                      updateField("prescriptions", index, "duration_en", val)
                    }
                    options={durationOptions}
                    urdu
                    bilingual={true}
                    className="flex-1 min-w-[150px]"
                  />
                  <SelectField
                    label="ہدایات"
                    value={med.instructions_urdu}
                    englishValue={med.instructions_en}
                    onChange={(val) =>
                      updateField(
                        "prescriptions",
                        index,
                        "instructions_urdu",
                        val
                      )
                    }
                    onEnglishChange={(val) =>
                      updateField(
                        "prescriptions",
                        index,
                        "instructions_en",
                        val
                      )
                    }
                    options={instructionsOptions}
                    urdu
                    bilingual={true}
                    className="flex-1 min-w-[150px]"
                  />
                  <button
                    type="button"
                    onClick={() => removeMedicine(index)}
                    className="text-red-500 hover:text-red-600 hover:scale-110 transition-all"
                    aria-label="Remove Medicine"
                  >
                    <FaTrash className="w-5 h-5" />
                  </button>
                </motion.div>
              ))}
              <button
                type="button"
                onClick={addMedicine}
                className={`mt-4 px-4 py-2 bg-teal-500 text-white rounded-md flex items-center gap-2 transition-colors ${
                  allMedicines.length === 0
                    ? "opacity-50 cursor-not-allowed"
                    : "hover:bg-teal-600"
                }`}
                disabled={allMedicines.length === 0}
              >
                <FaPlus /> Add Medicine
              </button>
              {allMedicines.length === 0 && (
                <p className="mt-2 text-sm text-amber-600 font-urdu">
                  نوٹ: دوائیوں کی فہرست لوڈ ہونے تک نئی دوائیاں شامل نہیں کی جا
                  سکتیں۔
                </p>
              )}
            </motion.div>

            {/* Diagnosis */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.7 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaNotesMedical className="w-6 h-6 text-orange-500" />
                Diagnosis
              </h3>
              <FormField
                label="Diagnosis"
                placeholder="Enter diagnosis"
                value={editFormData.diagnosis}
                onChange={(val) => handleFormChange("diagnosis", val)}
              />
              <FormField
                label="Treatment Plan"
                placeholder="Enter treatment plan"
                value={editFormData.treatment_plan}
                onChange={(val) => handleFormChange("treatment_plan", val)}
              />
            </motion.div>

            {/* Follow-ups */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.8 }}
              className="bg-gray-50 p-6 rounded-xl shadow-sm"
            >
              <h3 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
                <FaNotesMedical className="w-6 h-6 text-pink-500" />
                Follow-ups
              </h3>
              {editFormData.follow_ups?.map((followUp, index) => (
                <div
                  key={index}
                  className="mb-4 p-4 bg-white rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-4"
                >
                  <FormField
                    label="Follow-up Date"
                    type="date"
                    value={followUp.follow_up_date}
                    onChange={(val) =>
                      updateField("follow_ups", index, "follow_up_date", val)
                    }
                  />
                  <FormField
                    label="Notes"
                    placeholder="Enter notes"
                    value={followUp.notes}
                    onChange={(val) =>
                      updateField("follow_ups", index, "notes", val)
                    }
                  />
                </div>
              ))}
            </motion.div>

            {/* Form Actions */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.9 }}
              className="flex justify-end gap-4 mt-8"
            >
              <button
                type="button"
                onClick={handleCancel}
                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                disabled={editLoading}
                className={`px-6 py-3 bg-teal-500 text-white rounded-md flex items-center gap-2 transition-all ${
                  editLoading
                    ? "opacity-50 cursor-not-allowed"
                    : "hover:bg-teal-600 active:bg-teal-700 active:scale-95"
                }`}
              >
                {editLoading ? (
                  <>
                    <svg
                      className="animate-spin w-4 h-4"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      strokeWidth="2"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    >
                      <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                    </svg>
                    Saving...
                  </>
                ) : (
                  "Update Consultation"
                )}
              </button>
            </motion.div>
          </form>
        ) : (
          <p className="text-center text-gray-500">
            No consultation data available.
          </p>
        )}
      </motion.div>
    </div>
  );
};

export default EditConsultation;
